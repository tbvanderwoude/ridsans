# Manual
This document contains both a high-level overview of the system 

## 1. High-level overview
The reduction systems consists of three basic modules
1. The [sansdata](../sansdata.py) module which loads `.mpa` files as `SansData` Python objects
2. The [load_RIDSANS](../load_RIDSANS.py) module for creating Mantid workspaces from `SansData` objects (or `.mpa` files using these as intermediate representation)
3. The [reduce_RIDSANS](../reduce_RIDSANS.py) module to reduce loaded measurement workspaces to final workspaces in units of the macroscopic cross-section that can saved as [SasView](https://www.sasview.org/)-compatible [NeXuS files](https://www.nexusformat.org/).

Together, these bridge the gap between raw measurement files and what [SasView](https://www.sasview.org/) expects. Additionally, there are some utility modules that enable working with a batchfile spreadsheet as well as notebooks to perform specific tasks like determining the pixel efficiencies. 

### 1.1. From `.mpa` file to `SansData` Python object
The first step in the reduction is loading the raw `.mpa` files generated by the instrument as Python objects that can be worked with and contain all relevant information. This is done by the [sansdata](../sansdata.py) module. This can be used to take a look at specific measurement files and plot the counts as is done in [image-viewer.ipynb](../image-viewer.ipynb)

### 1.2. Loading measurements as Mantid workspaces
Mantid workspaces need to be created from the measurement data. The [load_RIDSANS](../load_RIDSANS.py) module provides different methods to do this, making it possible to create workspaces from `SansData` objects or directly from file names, using [sansdata](../sansdata.py) to perform the necessary conversion.

### 1.3. Reduce loaded measurement workspaces
Having gone through a few steps to prepare the data in a Mantid-friendly format, the[reduce_RIDSANS](../reduce_RIDSANS.py) takes as input the loaded Mantid workspaces. This is a two-step process: first, the `reduction_setup_RIDSANS` function is used to determine the center of the beam, shifting the relative detector position to compensate for this beam center, and optionally apply ROI-type masking. Additional masking can be applied in the Mantid workbench by drawing in masks in the `Show Instrument` view of the workspace. Next, `reduce_RIDSANS_1D` or `reduce_RIDSANS_2D` can be used to reduce the workspace to units of macroscopic cross-section.

## 2. Usage guide
There are two main ways of using the libraries in this repository to reduce RIDSANS data
1. Running Python scripts in the Mantid workbench
2. Using Jupyter notebooks together with the Mantid Python API

Option 1 has the advantage of making it easier to perform tasks like drawing masks on the measurement workspaces in a user-friendly interface whereas option 2 might be more familiar to those that have never used Mantid before. Notebooks can also be more convenient when making plots, as Mantid plotting by default is more suited for time-of-flight rather than 2D monochromatic scattering data.

Both options assume your data is stored in the `data` folder inside this repository and file and workspace names are relative to this. In some examples, all used file names are seperately specified as in [load_example.py](load_example.py). To facilitate processing of multiple measurements in a way [similar to that used at ISIS](https://www.isis.stfc.ac.uk/Pages/SANSdataReduction.aspx), the different file names for each measurement set can be specified in [sans-batchfile.csv](sans-batchfile.csv). For samples without a can (container), the `can scatter,can trans` columns can simply be left blank. You can simply enter the measurement numbers or if you prefer you can first rename all `.mpa` files to their respective sample names using the provided [data-renamer.py](data-renamer.py) script. 

### Method 1: Scripts in the workbench
To open the Mantid workbench, run
```bash
mantidworkbench
```
You can close the pop-up and go to File to open a script such as [load_example.py](load_example.py) or [batch_load_example.py](batch_load_example.py) if you want to use the batchfile approach to load data. Similarly, the [reduce_example.py](reduce_example.py) and [batch_reduce_example.py](batch_reduce_example.py) show how to reduce the data to workspaces that can be saved and viewed in SasView

### Method 2: Jupyter notebook
As an alternative, you can use a notebook like [reduction-example.ipynb](reduction-example.ipynb) to load and process various files and make plots. 